<!DOCTYPE html><html lang="es"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/><title>Historial • Flybondi</title><link rel="manifest" href="manifest.webmanifest"><link rel="stylesheet" href="css/styles.css"></head><body><header class="topbar"><div class="brand"><img src="assets/flybondi-logo.png" class="logo" alt="Flybondi"/><h1>Historial</h1></div><nav class="actions"><a class="btn" href="index.html">Escanear</a><a class="btn" href="flights.html">Vuelos escaneados</a></nav></header><main class="container"><section class="card"><h2>Filtros</h2><div class="grid"><label>Vuelo <input id="f_vuelo" type="text"></label><label>Origen <input id="f_origen" type="text"></label><label>Destino <input id="f_destino" type="text"></label><label>Supervisor <input id="f_resp" type="text"></label><label>Carro <input id="f_carro" type="text"></label></div><div class="row"><button id="applyFilters" class="btn">Aplicar</button><button id="clearFilters" class="btn secondary">Limpiar</button></div></section><section class="card"><h2>Resultados</h2><div class="row"><button id="exportCsv" class="btn">Exportar CSV</button><button id="exportJson" class="btn">Exportar JSON</button><button id="retrySync" class="btn primary">Reintentar sincronización</button></div><div id="historyList" class="list"></div></section></main><footer class="footer">Hecho para rampa • Funciona offline • PWA</footer><script src="js/utils.js"></script><script src="js/storage.js"></script><script src="js/sheets.js"></script><script>(async()=>{const q=await StorageAPI.getAllBatches();const listEl=document.getElementById('historyList');function render(items){listEl.innerHTML='';if(items.length===0){listEl.innerHTML='<div class=\"item\">Sin registros.</div>';return}items.forEach(batch=>{const meta=batch.meta||{};const when=new Date(batch.created).toLocaleString();const div=document.createElement('div');div.className='item';div.innerHTML=`<div class=\"item-head\"><strong>${meta.vuelo??'(sin vuelo)'} • ${meta.origen??''}→${meta.destino??''}</strong><small>${when}</small></div><div class=\"item-body\"><div>${meta.responsable??meta.supervisor??''} • ${batch.mode??'cam'} • Carro: ${meta.carro??'-'} • Cart #${meta.cartIndex??''}</div><div>${(batch.items||[]).length} bultos</div><pre class=\"codes\">${(batch.items||[]).map(i=>i.code).join('\\n')}</pre></div>`;listEl.appendChild(div)})}
function apply(){const fv=document.getElementById('f_vuelo').value.trim().toLowerCase();const fo=document.getElementById('f_origen').value.trim().toLowerCase();const fd=document.getElementById('f_destino').value.trim().toLowerCase();const fr=document.getElementById('f_resp').value.trim().toLowerCase();const fc=document.getElementById('f_carro').value.trim().toLowerCase();const filtered=q.filter(b=>{const m=(b.meta||{});return(!fv||(m.vuelo||'').toLowerCase().includes(fv))&&(!fo||(m.origen||'').toLowerCase().includes(fo))&&(!fd||(m.destino||'').toLowerCase().includes(fd))&&(!fr||((m.responsable||m.supervisor||'').toLowerCase().includes(fr)))&&(!fc||(m.carro||'').toLowerCase().includes(fc))});render(filtered)}
document.getElementById('applyFilters').onclick=apply;document.getElementById('clearFilters').onclick=()=>{['f_vuelo','f_origen','f_destino','f_resp','f_carro'].forEach(id=>document.getElementById(id).value='');render(q)};document.getElementById('exportCsv').onclick=async()=>{const csv=await StorageAPI.exportCSV();Utils.downloadText('historial.csv',csv)};document.getElementById('exportJson').onclick=async()=>{const js=await StorageAPI.exportJSON();Utils.downloadText('historial.json',js)};document.getElementById('retrySync').onclick=async()=>{await SheetsAPI.syncPending();alert('Reintentos lanzados. Mirá la consola.')};render(q)})();</script></body></html>