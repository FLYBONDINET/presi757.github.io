<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Scanner de Valijas - Web</title>
<style>
  :root{
    --bg:#0f172a;
    --panel:#111827;
    --card:#1f2937;
    --text:#fff;
    --accent:#2563eb;
  }
  body{ margin:0; font-family:sans-serif; background:var(--bg); color:var(--text);}
  header{padding:10px; background:var(--panel); display:flex; justify-content:space-between; align-items:center;}
  header h1{margin:0; font-size:1.2em;}
  nav{position:relative;}
  nav ul{list-style:none; margin:0; padding:0; display:flex; flex-direction:column; position:absolute; top:40px; right:0; background:var(--panel); display:none;}
  nav ul li{padding:10px; border-bottom:1px solid #222;}
  nav ul li:hover{background:#1f2937; cursor:pointer;}
  nav.active ul{display:flex;}
  #contenido{padding:10px;}
  #video{width:100%; max-width:400px;}
  table{width:100%; border-collapse:collapse; margin-top:10px;}
  th, td{padding:5px; border:1px solid #444; text-align:left;}
  button{padding:5px 10px; margin:5px; background:var(--accent); color:#fff; border:none; border-radius:4px; cursor:pointer;}
  button:hover{background:#1d4ed8;}
</style>
</head>
<body>
<header>
  <h1>Scanner de Valijas</h1>
  <nav id="menu">
    <span id="btnMenu">☰ Menú</span>
    <ul>
      <li data-tab="escaneo">Escaneo</li>
      <li data-tab="vuelos">Vuelos</li>
      <li data-tab="historial">Historial</li>
      <li data-tab="exportar">Exportar</li>
      <li data-tab="ayuda">Ayuda</li>
    </ul>
  </nav>
</header>

<div id="contenido">
  <section id="escaneo" style="display:grid;">
    <h2>Escaneo</h2>
    <video id="video" autoplay playsinline></video>
    <select id="listaCamaras"></select>
    <button id="btnCamara">Iniciar Cámara</button>
    <button id="btnLinterna">Linterna</button>
    <input type="text" id="inputManual" placeholder="Ingresar código manual"/>
    <button id="btnAgregarManual">Agregar</button>
    <div>Última lectura: <span id="ultimaLectura">—</span></div>
    <table id="tablaVuelo">
      <thead>
        <tr>
          <th><input type="checkbox" id="chkAll"></th>
          <th>#</th>
          <th>Código</th>
          <th>Fecha/Hora</th>
          <th>Operador</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div>Total: <span id="totalVuelo">0</span></div>
    <button id="btnDeshacer">Deshacer</button>
    <button id="btnBorrarSeleccionadas">Borrar Seleccionadas</button>
  </section>
  <section id="vuelos" style="display:none;">Vuelos</section>
  <section id="historial" style="display:none;">Historial</section>
  <section id="exportar" style="display:none;">Exportar</section>
  <section id="ayuda" style="display:none;">Ayuda</section>
</div>

<script>
const $=s=>document.querySelector(s);
const $$=s=>[...document.querySelectorAll(s)];

let state={scans:[]};
function dbSave(){ localStorage.setItem('scannerState',JSON.stringify(state)); }
function dbLoad(){ const d=localStorage.getItem('scannerState'); if(d) state=JSON.parse(d); }
dbLoad();

let operador="Usuario";
function newId(){ return Date.now() + Math.random().toString(16).slice(2); }
function fmtDateTime(dt){ const d=new Date(dt); return d.toLocaleString(); }

function play(ok){ 
  const audio = new Audio(ok?'https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg':'https://actions.google.com/sounds/v1/cartoon/boing.ogg');
  audio.play();
}

function addScanRaw(code){
  if(!code) return;
  if(state.scans.some(s=>s.code===code)){ play(false); return; }
  const scan={id:newId(),code,operador,date:new Date().toISOString()};
  state.scans.push(scan);
  dbSave();
  $('#ultimaLectura').textContent=code;
  renderVueloTable();
  play(true);
}

$('#btnAgregarManual').addEventListener('click',()=>{
  const val=$('#inputManual').value.trim();
  if(val) addScanRaw(val);
  $('#inputManual').value='';
});

function renderVueloTable(){
  const tbody=$('#tablaVuelo tbody');
  tbody.innerHTML='';
  state.scans.forEach((s,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input type="checkbox" data-id="${s.id}"></td>
                  <td>${i+1}</td>
                  <td>${s.code}</td>
                  <td>${fmtDateTime(s.date)}</td>
                  <td>${s.operador}</td>`;
    tbody.appendChild(tr);
  });
  $('#totalVuelo').textContent=state.scans.length;
}

$('#chkAll').addEventListener('change',e=>{
  const ch = e.target.checked;
  $$('#tablaVuelo tbody input[type=checkbox]').forEach(x=>x.checked=ch);
});

$('#btnDeshacer').addEventListener('click',()=>{
  if(!state.scans.length) return;
  state.scans.pop();
  dbSave();
  renderVueloTable();
});

$('#btnBorrarSeleccionadas').addEventListener('click',()=>{
  const checked = $$('#tablaVuelo tbody input[type=checkbox]:checked').map(x=>x.dataset.id);
  state.scans = state.scans.filter(s=>!checked.includes(s.id));
  dbSave();
  renderVueloTable();
});

// Menú desplegable
$('#btnMenu').addEventListener('click',()=>$('#menu').classList.toggle('active'));
$$('nav ul li').forEach(li=>{
  li.addEventListener('click',()=>{
    $$('nav ul li').forEach(l=>l.classList.remove('active'));
    li.classList.add('active');
    $$('#contenido section').forEach(sec=>sec.style.display='none');
    document.getElementById(li.dataset.tab).style.display='grid';
    $('#menu').classList.remove('active');
  });
});

// Cámara y Linterna
let stream;
const video = $('#video');
let track;

$('#btnCamara').addEventListener('click', async()=>{
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  const devices = await navigator.mediaDevices.enumerateDevices();
  const cams = devices.filter(d=>d.kind==='videoinput');
  const sel=$('#listaCamaras'); sel.innerHTML='';
  cams.forEach((c,i)=>{
    const opt=document.createElement('option'); opt.value=c.deviceId; opt.textContent=c.label||`Cam ${i+1}`; sel.appendChild(opt);
  });
  if(cams.length) startCamera(cams[0].deviceId);
});

$('#listaCamaras').addEventListener('change',()=>startCamera($('#listaCamaras').value));

async function startCamera(deviceId){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  stream = await navigator.mediaDevices.getUserMedia({video:{deviceId:deviceId},facingMode:'environment'},audio=false);
  video.srcObject = stream;
  track = stream.getVideoTracks()[0];
  detectLoop();
}

$('#btnLinterna').addEventListener('click',()=>{
  if(track && 'torch' in track.getCapabilities()){
    const cap = track.getCapabilities();
    const settings = track.getSettings();
    track.applyConstraints({advanced:[{torch:!(settings.torch||false)}]});
  }else{
    alert('Tu cámara no soporta linterna');
  }
});

// Barcode detection
let detector = ('BarcodeDetector' in window)? new BarcodeDetector({formats:['code_128','code_39','ean_13','ean_8','upc_a','upc_e']}) : null;

async function detectLoop(){
  if(!stream) return;
  if(detector){
    try{
      const results = await detector.detect(video);
      if(results.length) results.forEach(r=>addScanRaw(r.rawValue));
    }catch(e){}
  }
  requestAnimationFrame(detectLoop);
}

// Inicial
renderVueloTable();
</script>
</body>
</html>
