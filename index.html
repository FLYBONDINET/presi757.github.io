<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Scanner de Valijas - Solo C√°mara</title>
<style>
:root{
  --bg:#0f172a;
  --card:#1f2937;
  --muted:#9ca3af;
  --ring:#3b82f6;
}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:#fff}
header{position:sticky;top:0;background:#111827;padding:8px;border-bottom:1px solid #1f2937}
.container{max-width:1100px;margin:0 auto;padding:8px}
h1{font-size:1.25rem;margin:0}
.card{background:var(--card);padding:16px;border-radius:12px;margin-bottom:16px}
.camera{width:100%;aspect-ratio:16/9;background:#000;border-radius:12px;overflow:hidden;border:1px solid #374151}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.btn{padding:8px 12px;border-radius:12px;border:1px solid #374151;background:#111827;color:#e5e7eb;cursor:pointer}
.btn.primary{background:var(--ring);border-color:transparent;color:white}
.muted{color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="container">
    <h1>üß≥ Scanner de Valijas (C√°mara)</h1>
  </div>
</header>

<main class="container">
  <div class="card">
    <h2>Sesi√≥n de vuelo</h2>
    <div>
      <label for="vueloNumero">N¬∞ de vuelo</label>
      <input id="vueloNumero" placeholder="Ej: AR1234" />
      <label for="vueloFecha">Fecha</label>
      <input id="vueloFecha" type="date" />
      <div class="actions">
        <button class="btn primary" id="btnNuevaSesion">Iniciar/Actualizar Sesi√≥n</button>
      </div>
      <p class="muted">La sesi√≥n activa define a qu√© vuelo se asociar√°n los escaneos.</p>
      <p>Vuelo activo: <span id="vueloActivo">‚Äî</span></p>
    </div>
  </div>

  <div class="card">
    <h2>Escanear etiqueta de valija</h2>
    <div>
      <label for="operador">Operador</label>
      <input id="operador" placeholder="Nombre del operador" />
      <div class="camera"><video id="video" autoplay playsinline muted style="width:100%;height:100%;object-fit:cover"></video></div>
      <div class="actions">
        <button class="btn" id="btnCamara">Iniciar c√°mara</button>
        <select id="listaCamaras"></select>
      </div>
      <div class="actions">
        <label><input type="checkbox" id="chkValidar" checked /> Validar etiqueta (IATA)</label>
        <label><input type="checkbox" id="chkDuplicados" checked /> Evitar duplicados</label>
        <label><input type="checkbox" id="chkAudio" checked /> Sonido</label>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Valijas del vuelo activo</h2>
    <div>
      <div class="actions">
        <span>Total: <b id="totalVuelo">0</b></span>
        <span>√öltima: <span id="ultimaLectura" class="muted">‚Äî</span></span>
      </div>
      <div style="overflow:auto;max-height:45vh;border:1px solid #334155;border-radius:12px">
        <table id="tablaVuelo" style="width:100%;border-collapse:collapse">
          <thead>
            <tr>
              <th>#</th>
              <th>Etiqueta</th>
              <th>Fecha/Hora</th>
              <th>Operador</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</main>

<audio id="beepOk" preload="auto"><source src="data:audio/wav;base64,UklGRoYAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYBHGZmZmZmZmY=" type="audio/wav"></audio>
<audio id="beepErr" preload="auto"><source src="data:audio/wav;base64,UklGRoYAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYBHGZmZmZmZmY=" type="audio/wav"></audio>

<script>
// ---------- Persistencia ----------
const DB_KEY = 'scannerValijasDB.v1';
const db = {
  load(){ try{ return JSON.parse(localStorage.getItem(DB_KEY)) || { vuelos:[], scans:[], active:null }; } catch(e){ return { vuelos:[], scans:[], active:null }; } },
  save(data){ localStorage.setItem(DB_KEY, JSON.stringify(data)); }
};
let state = db.load();

// ---------- Utilidades ----------
const $ = sel => document.querySelector(sel);
const fmtDateTime = iso => new Date(iso).toLocaleString();
const play = ok => { if(!$('#chkAudio').checked) return; (ok? $('#beepOk'): $('#beepErr')).currentTime=0; (ok? $('#beepOk'): $('#beepErr')).play().catch(()=>{}); };
function newId(){ return Math.random().toString(36).slice(2,10)+Date.now().toString(36); }
function validaIATATag(code){
  if(!/^\d{10}$/.test(code)) return false;
  const digits = code.split('').map(d=>+d); const check = digits.pop();
  let sum = 0;
  for(let i=0;i<digits.length;i++){ let v=digits[i]; v=i%2===0?v*3:v; sum+=v; }
  const calc = (10-(sum%10))%10;
  return calc===check;
}
function setActiveVuelo(vueloId){ state.active=vueloId; db.save(state); renderActive(); renderVueloTable(); }
function getActiveVuelo(){ return state.vuelos.find(v=>v.id===state.active)||null; }
function ensureSesionFromForm(){
  const n=$('#vueloNumero').value.trim().toUpperCase();
  const f=$('#vueloFecha').value||new Date().toISOString().slice(0,10);
  if(!n){ alert('Ingrese n√∫mero de vuelo'); return null; }
  let v=state.vuelos.find(x=>x.numero===n && x.fecha===f);
  if(!v){ v={id:newId(), numero:n, fecha:f}; state.vuelos.push(v); }
  db.save(state); setActiveVuelo(v.id); return v;
}

// ---------- Escaneo ----------
function addScanRaw(code){
  const v=getActiveVuelo();
  if(!v){ alert('No hay sesi√≥n activa'); play(false); return; }
  const operador=$('#operador').value.trim()||'';
  const valida=$('#chkValidar').checked ? validaIATATag(code):true;
  const duplicados=$('#chkDuplicados').checked;
  if(!valida){ play(false); markLast(code,'err'); return; }
  if(duplicados && state.scans.some(s=>s.vueloId===v.id && s.code===code)){ play(false); markLast(code,'dup'); return; }
  const scan={id:newId(), vueloId:v.id, vuelo:v.numero, ts:new Date().toISOString(), code, operador};
  state.scans.unshift(scan); db.save(state); renderVueloTable();
  $('#ultimaLectura').textContent=code;
  $('#totalVuelo').textContent=state.scans.filter(s=>s.vueloId===v.id).length;
  play(true);
}
function markLast(code,cls){ $('#ultimaLectura').textContent=code; }

// ---------- Render ----------
function renderActive(){ const v=getActiveVuelo(); $('#vueloActivo').textContent=v?v.numero+' ‚Ä¢ '+v.fecha:'‚Äî'; }
function renderVueloTable(){
  const v=getActiveVuelo(); const tbody=$('#tablaVuelo tbody'); tbody.innerHTML=''; if(!v) return;
  state.scans.filter(s=>s.vueloId===v.id).forEach((s,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${idx+1}</td><td>${s.code}</td><td>${fmtDateTime(s.ts)}</td><td>${s.operador||''}</td>`;
    tbody.appendChild(tr);
  });
}

// ---------- C√°mara ----------
let stream=null, detector=null, camLoop=false;
async function initCamaras(){
  try{
    const devices=(await navigator.mediaDevices.enumerateDevices()).filter(d=>d.kind==='videoinput');
    const sel=$('#listaCamaras'); sel.innerHTML='';
    devices.forEach(d=>{ const o=document.createElement('option'); o.value=d.deviceId; o.textContent=d.label||'C√°mara'; sel.appendChild(o); });
  }catch{}
}
async function startCam(){
  try{
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    const deviceId=$('#listaCamaras').value||undefined;
    stream=await navigator.mediaDevices.getUserMedia({video:{deviceId,facingMode:'environment'}});
    $('#video').srcObject=stream;
    if('BarcodeDetector' in window){ detector=new BarcodeDetector({formats:['code_128','ean_13','ean_8','upc_a','upc_e','code_39','qr_code']}); camLoop=true; loopDetect(); }
    else{ alert('BarcodeDetector no soportado'); }
  }catch(err){ alert('No se pudo iniciar la c√°mara: '+err.message); }
}
async function loopDetect(){
  while(camLoop){
    try{
      const codes=await detector.detect($('#video'));
      if(codes && codes.length){ const val=codes[0].rawValue?.trim(); if(val){ addScanRaw(val); await new Promise(r=>setTimeout(r,800)); } }
    }catch{}
    await new Promise(r=>setTimeout(r,120));
  }
}
$('#btnCamara').addEventListener('click',()=>startCam());
initCamaras();

// ---------- Sesi√≥n ----------
$('#btnNuevaSesion').addEventListener('click',ensureSesionFromForm);

// ---------- Init ----------
(function init(){
  if(!$('#vueloFecha').value) $('#vueloFecha').value=new Date().toISOString().slice(0,10);
  renderActive(); renderVueloTable();
})();
</script>
</body>
</html>
