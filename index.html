<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scanner de Valijas - Web</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --card:#1f2937;
      --muted:#9ca3af; --accent:#22c55e; --danger:#ef4444;
    }
    body{margin:0;font-family:system-ui;background:var(--bg);color:#fff}
    header{position:sticky;top:0;background:var(--panel);padding:10px 16px;
           display:flex;align-items:center;justify-content:space-between;z-index:50}
    h1{font-size:1.1rem;margin:0}
    /* Hamburguesa */
    .menu-btn{background:none;border:none;cursor:pointer;width:32px;height:32px;
              display:flex;flex-direction:column;justify-content:space-around}
    .menu-btn span{display:block;height:3px;background:#fff;border-radius:2px}
    nav{position:absolute;top:56px;left:0;right:0;background:var(--panel);
        display:none;flex-direction:column}
    nav.show{display:flex;}
    nav button{padding:12px;border:none;background:none;color:#fff;text-align:left;
               font-size:1rem;cursor:pointer;border-bottom:1px solid #374151}
    main{padding:16px}
    .card{background:var(--card);border:1px solid #374151;border-radius:12px;
          padding:16px;margin-bottom:16px}
    .camera{width:100%;aspect-ratio:16/9;background:#000;border-radius:12px;
            overflow:hidden;border:1px solid #374151}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #374151;padding:6px;text-align:left;font-size:.9rem}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid #374151;cursor:pointer}
    .btn.green{background:var(--accent);border-color:transparent;color:#052e16}
    .btn.red{background:var(--danger);border-color:transparent;color:white}
  </style>
</head>
<body>
  <header>
    <h1>üß≥ Scanner Valijas</h1>
    <button class="menu-btn" id="menuBtn">
      <span></span><span></span><span></span>
    </button>
    <nav id="menu">
      <button data-tab="escaneo">Escaneo</button>
      <button data-tab="vuelos">Vuelos</button>
      <button data-tab="historial">Historial</button>
      <button data-tab="exportar">Exportar</button>
      <button data-tab="ayuda">Ayuda</button>
    </nav>
  </header>

  <main>
    <!-- Escaneo -->
    <section id="escaneo">
      <div class="card">
        <h2>Escanear etiqueta</h2>
        <div class="camera">
          <video id="video" autoplay playsinline muted style="width:100%;height:100%;object-fit:cover"></video>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="btnCamara" class="btn green">Iniciar c√°mara</button>
          <button id="btnTorch" class="btn" disabled>Linterna</button>
        </div>
        <p id="lastScan">√öltima lectura: ‚Äî</p>
      </div>
      <div class="card">
        <h2>Resultados</h2>
        <table id="tabla">
          <thead><tr><th>#</th><th>Tipo</th><th>C√≥digo</th><th>Hora</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Vuelos -->
    <section id="vuelos" style="display:none">
      <div class="card"><h2>Vuelos</h2><p>Listado de vuelos (demo).</p></div>
    </section>

    <!-- Historial -->
    <section id="historial" style="display:none">
      <div class="card"><h2>Historial</h2><p>Aqu√≠ se listar√° el historial.</p></div>
    </section>

    <!-- Exportar -->
    <section id="exportar" style="display:none">
      <div class="card"><h2>Exportar</h2><p>Opciones de exportaci√≥n.</p></div>
    </section>

    <!-- Ayuda -->
    <section id="ayuda" style="display:none">
      <div class="card"><h2>Ayuda</h2><p>Gu√≠a r√°pida de uso.</p></div>
    </section>
  </main>

<script>
// ===== Men√∫ =====
const menuBtn=document.getElementById("menuBtn");
const menu=document.getElementById("menu");
menuBtn.addEventListener("click",()=> menu.classList.toggle("show"));
menu.querySelectorAll("button").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll("main section").forEach(s=>s.style.display="none");
    document.getElementById(btn.dataset.tab).style.display="block";
    menu.classList.remove("show"); // cierre autom√°tico
  });
});

// ===== Esc√°ner =====
let detector=null,stream=null,imageCapture=null,torchOn=false;

async function startCam(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    document.getElementById("video").srcObject=stream;

    const track=stream.getVideoTracks()[0];
    const capabilities=track.getCapabilities?.() || {};
    if(capabilities.torch){
      imageCapture=new ImageCapture(track);
      const torchBtn=document.getElementById("btnTorch");
      torchBtn.disabled=false;
      torchBtn.textContent="Linterna ON";
      torchBtn.className="btn green";
    }

    if("BarcodeDetector" in window){
      detector = new BarcodeDetector({
        formats:["code_128","code_39","ean_13","ean_8","upc_a","upc_e","itf","qr_code"]
      });
      detectLoop();
    }else{
      alert("BarcodeDetector no soportado en este navegador.");
    }
  }catch(err){alert("Error c√°mara: "+err);}
}

async function detectLoop(){
  const video=document.getElementById("video");
  while(stream && detector){
    try{
      const codes=await detector.detect(video);
      if(codes.length>0){
        const code=codes[0].rawValue;
        const tipo=codes[0].format;
        logScan(code,tipo);

        // Vibraci√≥n
        if("vibrate" in navigator){ navigator.vibrate(80); }

        // Sonido beep
        beep();

        await new Promise(r=>setTimeout(r,900)); // evitar duplicados r√°pidos
      }
    }catch(e){}
    await new Promise(r=>setTimeout(r,140));
  }
}

function logScan(code,tipo){
  document.getElementById("lastScan").textContent=`√öltima lectura: ${code} (${tipo})`;
  const tbody=document.querySelector("#tabla tbody");
  const tr=document.createElement("tr");
  tr.innerHTML=`<td>${tbody.children.length+1}</td><td>${tipo}</td><td>${code}</td><td>${new Date().toLocaleTimeString()}</td>`;
  tbody.prepend(tr);
}

// Botones
document.getElementById("btnCamara").addEventListener("click",startCam);
document.getElementById("btnTorch").addEventListener("click",async()=>{
  if(!imageCapture || !stream) return;
  const track=stream.getVideoTracks()[0];
  torchOn=!torchOn;
  await track.applyConstraints({advanced:[{torch:torchOn}]});
  const btn=document.getElementById("btnTorch");
  btn.textContent=torchOn?"Linterna OFF":"Linterna ON";
  btn.className=torchOn?"btn red":"btn green";
});

// ===== Sonido beep =====
function beep(){
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator();
    const gain=ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.type="sine"; osc.frequency.setValueAtTime(900,ctx.currentTime);
    gain.gain.setValueAtTime(0.1,ctx.currentTime);
    osc.start(); osc.stop(ctx.currentTime+0.15);
  }catch(e){}
}
</script>
</body>
</html>
