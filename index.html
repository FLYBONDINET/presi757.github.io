<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scanner de Valijas - Web (Camara + Linterna)</title>
  <style>
    :root{
      --bg:#0f172a;--panel:#111827;--card:#1f2937;--muted:#9ca3af;--accent:#22c55e;--accent-2:#f59e0b;--danger:#ef4444;--ring:#3b82f6;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;color:#fff;background:var(--bg)}
    header{position:sticky;top:0;z-index:40;background:linear-gradient(180deg, rgba(17,24,39,0.98), rgba(17,24,39,0.9));backdrop-filter: blur(6px);border-bottom:1px solid #1f2937}
    .container{max-width:1100px;margin:0 auto;padding:12px}
    .topbar{display:flex;align-items:center;gap:12px;justify-content:space-between}
    h1{font-size:1.05rem;margin:0;display:flex;align-items:center;gap:.5rem}
    .hamb{display:inline-flex;align-items:center;gap:.5rem;padding:8px;border-radius:8px;border:1px solid #2d3748;background:#071022;cursor:pointer}
    nav{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;transition:all .18s ease;overflow:hidden}
    nav.collapsed{max-height:0;padding:0;margin-top:0}
    nav.expanded{max-height:400px}
    .tab{padding:8px 12px;border:1px solid #374151;border-radius:.65rem;background:#0b1220;color:#e5e7eb;cursor:pointer}
    .tab.active{outline:2px solid var(--ring);background:#071028}
    main{padding:16px}
    .grid{display:grid;gap:16px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:900px){.grid.cols-2{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #374151;border-radius:12px;overflow:hidden}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid #374151;font-size:1rem}
    .card .body{padding:14px}
    label{display:block;font-size:.9rem;margin:8px 0 4px;color:#e5e7eb}
    input,select,textarea,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
    input:focus,select:focus,textarea:focus{outline:2px solid var(--ring);border-color:transparent}
    button{cursor:pointer}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .row > *{flex:1}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:10px 12px;border:1px solid #374151;background:#111827;border-radius:10px;color:#e5e7eb}
    .btn.primary{background:var(--ring);border-color:transparent;color:white}
    .btn.success{background:var(--accent);border-color:transparent;color:#052e16}
    .btn.warn{background:var(--accent-2);border-color:transparent;color:#1f1300}
    .btn.danger{background:var(--danger);border-color:transparent;color:#fff}
    .pill{display:inline-flex;gap:.5rem;align-items:center;padding:.35rem .6rem;border-radius:999px;border:1px solid #374151;background:#0b1220;color:#cbd5e1;font-size:.8rem}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #374151;padding:8px;text-align:left;font-size:.92rem}
    th{color:#cbd5e1;font-weight:600}
    tr.dup td{background:rgba(245,158,11,0.08)}
    tr.err td{background:rgba(239,68,68,0.08)}
    .camera{width:100%;aspect-ratio:16/9;background:#000;border-radius:10px;overflow:hidden;border:1px solid #374151;position:relative}
    #video{width:100%;height:100%;object-fit:cover}
    .cam-controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .footer{padding:12px;text-align:center;color:#94a3b8}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .small{font-size:.85rem}
  </style>
  <!-- ZXing fallback (BrowserMultiFormatReader) -->
  <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <div class="topbar">
        <div style="display:flex;align-items:center;gap:10px">
          <div class="hamb" id="hamb"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M4 7h16M4 12h16M4 17h16" stroke="#cbd5e1" stroke-width="2" stroke-linecap="round"/></svg></div>
          <h1>üß≥ Scanner de Valijas <span class="badge" style="font-size:.7rem;padding:.1rem .45rem;border-radius:.4rem;border:1px solid #374151;color:#d1d5db;margin-left:6px">Web</span></h1>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="pill small">v1.1 ‚Ä¢ C√°mara</div>
        </div>
      </div>
      <nav id="tabs" class="collapsed">
        <button class="tab active" data-tab="escaneo">Escaneo</button>
        <button class="tab" data-tab="vuelos">Vuelos</button>
        <button class="tab" data-tab="historial">Historial</button>
        <button class="tab" data-tab="exportar">Exportar / Herramientas</button>
        <button class="tab" data-tab="ayuda">Ayuda</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- Escaneo -->
    <section id="escaneo" class="grid cols-2">
      <div class="card">
        <h2>Sesi√≥n de vuelo</h2>
        <div class="body">
          <div class="row">
            <div>
              <label for="vueloNumero">N¬∞ de vuelo</label>
              <input id="vueloNumero" placeholder="Ej: AR1234" autocomplete="off" />
            </div>
            <div>
              <label for="vueloFecha">Fecha</label>
              <input id="vueloFecha" type="date" />
            </div>
          </div>
          <div class="row">
            <div>
              <label for="origen">Origen</label>
              <input id="origen" placeholder="Ej: AEP" maxlength="3" />
            </div>
            <div>
              <label for="destino">Destino</label>
              <input id="destino" placeholder="Ej: NQN" maxlength="3" />
            </div>
          </div>
          <div class="actions" style="margin-top:8px">
            <button class="btn primary" id="btnNuevaSesion">Iniciar/Actualizar Sesi√≥n</button>
            <button class="btn" id="btnCargarSesion">Cargar Sesi√≥n Guardada</button>
          </div>
          <p class="muted" style="margin-top:8px">La sesi√≥n activa define a qu√© vuelo se asociar√°n los escaneos.</p>
          <hr style="border:none;border-top:1px solid #374151;margin:12px 0">
          <div class="row">
            <div class="stat"><span class="pill">Vuelo activo</span> <span id="vueloActivo" class="muted">‚Äî</span></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Escanear etiqueta de valija (C√°mara / Zebra / Manual)</h2>
        <div class="body">
          <div class="row">
            <div>
              <label for="operador">Operador</label>
              <input id="operador" placeholder="Nombre del operador" />
            </div>
            <div>
              <label for="modoEntrada">Modo de entrada</label>
              <select id="modoEntrada">
                <option value="teclado">Zebra (teclado)</option>
                <option value="camara">C√°mara (si disponible)</option>
                <option value="manual">Manual</option>
              </select>
            </div>
          </div>

          <div id="zonaTeclado">
            <label for="scanInput">Apunte el esc√°ner aqu√≠ y dispare</label>
            <input id="scanInput" placeholder="Esperando lectura‚Ä¶" autofocus />
            <p class="muted">Consejo: configure el esc√°ner/DataWedge para enviar <span class="kbd">ENTER</span> al final.</p>
          </div>

          <div id="zonaCamara" style="display:none">
            <div class="camera">
              <video id="video" autoplay playsinline muted></video>
            </div>
            <div class="cam-controls">
              <button class="btn" id="btnCamara">Iniciar C√°mara</button>
              <button class="btn" id="btnPausarCam">Pausar C√°mara</button>
              <button class="btn" id="btnLinterna">Linterna ON</button>
              <select id="listaCamaras" style="min-width:140px"></select>
            </div>
            <p class="muted small" id="camStatus">Estado de c√°mara: ‚Äî</p>
            <p class="muted">Usa <code>BarcodeDetector</code> si el navegador lo soporta; de lo contrario se usa ZXing como fallback.</p>
          </div>

          <div id="zonaManual" style="display:none">
            <label for="manualInput">Ingresar etiqueta manualmente</label>
            <input id="manualInput" placeholder="Ej: 4061234567" />
            <button class="btn success" id="btnAgregarManual" style="margin-top:8px">Agregar</button>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="chip"><input id="chkValidar" type="checkbox" checked /> <label for="chkValidar">Validar etiqueta (IATA/Luhn)</label></div>
            <div class="chip"><input id="chkDuplicados" type="checkbox" checked /> <label for="chkDuplicados">Evitar duplicados</label></div>
            <div class="chip"><input id="chkAudio" type="checkbox" checked /> <label for="chkAudio">Sonido</label></div>
          </div>
        </div>
      </div>

      <div class="card" style="grid-column:1/-1">
        <h2>Valijas del vuelo activo</h2>
        <div class="body">
          <div class="actions" style="margin-bottom:8px">
            <span class="pill">Total: <b id="totalVuelo">0</b></span>
            <span class="pill">√öltima: <span id="ultimaLectura" class="muted">‚Äî</span></span>
            <button class="btn warn" id="btnDeshacer">Deshacer √∫ltima</button>
            <button class="btn danger" id="btnBorrarSeleccionadas">Borrar seleccionadas</button>
          </div>
          <div style="overflow:auto;max-height:45vh;border:1px solid #334155;border-radius:10px">
            <table id="tablaVuelo">
              <thead>
                <tr>
                  <th><input type="checkbox" id="chkAll"></th>
                  <th>#</th>
                  <th>Etiqueta</th>
                  <th>Fecha/Hora</th>
                  <th>Operador</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Vuelos -->
    <section id="vuelos" style="display:none" class="grid cols-2">
      <div class="card" style="grid-column:1/-1">
        <h2>Sesiones guardadas</h2>
        <div class="body">
          <div style="overflow:auto;max-height:60vh;border:1px solid #334155;border-radius:10px">
            <table id="tablaVuelos">
              <thead>
                <tr>
                  <th>Vuelo</th>
                  <th>Fecha</th>
                  <th>Ruta</th>
                  <th>Valijas</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Historial -->
    <section id="historial" style="display:none" class="grid cols-2">
      <div class="card" style="grid-column:1/-1">
        <h2>Historial completo</h2>
        <div class="body">
          <div style="overflow:auto;max-height:60vh;border:1px solid #334155;border-radius:10px">
            <table id="tablaHistorial">
              <thead>
                <tr>
                  <th>Vuelo</th>
                  <th>Fecha/Hora</th>
                  <th>Etiqueta</th>
                  <th>Operador</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Exportar -->
    <section id="exportar" style="display:none" class="grid cols-2">
      <div class="card">
        <h2>Exportar CSV</h2>
        <div class="body">
          <div class="actions">
            <button class="btn" id="btnExportVuelo">CSV del vuelo activo</button>
            <button class="btn" id="btnExportTodo">CSV de todo</button>
          </div>
          <p class="muted" style="margin-top:8px">El CSV incluye: vuelo, fecha/hora, etiqueta, operador.</p>
        </div>
      </div>
      <div class="card">
        <h2>Respaldo / Mantenimiento</h2>
        <div class="body">
          <div class="actions">
            <button class="btn" id="btnBackup">Descargar respaldo (JSON)</button>
            <label class="btn" for="fileRestore">Restaurar respaldo</label>
            <input id="fileRestore" type="file" accept="application/json" class="sr-only" />
            <button class="btn danger" id="btnPurgar">Borrar todo (local)</button>
          </div>
          <p class="muted" style="margin-top:8px">Los datos se guardan localmente en este dispositivo (LocalStorage). Se puede integrar luego a Google Sheets, Firebase o API propia.</p>
        </div>
      </div>
    </section>

    <!-- Ayuda -->
    <section id="ayuda" style="display:none">
      <div class="card">
        <h2>Gu√≠a r√°pida de uso con Zebra y c√°mara</h2>
        <div class="body">
          <ol>
            <li>En dispositivos Zebra Android, use <b>DataWedge</b> en modo <b>Keystroke</b> y agregue el sufijo <span class="kbd">ENTER</span>.</li>
            <li>Abra esta p√°gina en el dispositivo y mantenga el foco en el campo <i>Esperando lectura‚Ä¶</i> (modo teclado) o active la c√°mara (modo c√°mara).</li>
            <li>Si la c√°mara no detecta, pruebe cambiar la c√°mara (frontal/trasera) o aumentar la iluminaci√≥n; use la linterna con el bot√≥n.</li>
            <li>La validaci√≥n IATA valida etiquetas de 10 d√≠gitos con d√≠gito verificador.</li>
          </ol>
          <p class="muted">Para integraciones avanzadas (API/Sheets/Firebase, impresoras ZPL, modo offline PWA), podemos ampliar este MVP.</p>
        </div>
      </div>
    </section>

    <div class="footer">v1.1 ‚Ä¢ C√°mara + Linterna ‚Ä¢ Hecho para flujo de escaneo √°gil</div>
  </main>

  <!-- Sonidos -->
  <audio id="beepOk" preload="auto">
    <source src="data:audio/wav;base64,UklGRoYAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYBHGZmZmZmZmY=" type="audio/wav">
  </audio>
  <audio id="beepErr" preload="auto">
    <source src="data:audio/wav;base64,UklGRoYAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYBHGZmZmZmZmY=" type="audio/wav">
  </audio>

  <script>
  // ------------------ Persistencia (LocalStorage) ------------------
  const DB_KEY = 'scannerValijasDB.v1.1';
  const db = {
    load(){
      try { return JSON.parse(localStorage.getItem(DB_KEY)) || { vuelos: [], scans: [], active:null }; }
      catch(e){ return { vuelos: [], scans: [], active:null }; }
    },
    save(data){ localStorage.setItem(DB_KEY, JSON.stringify(data)); }
  };
  let state = db.load();

  // ------------------ Utilidades ------------------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const fmtDateTime = iso => new Date(iso).toLocaleString();
  const play = ok => { if(!$('#chkAudio').checked) return; (ok? $('#beepOk'): $('#beepErr')).currentTime=0; (ok? $('#beepOk'): $('#beepErr')).play().catch(()=>{}); };

  function newId(){ return Math.random().toString(36).slice(2,10)+Date.now().toString(36); }

  // IATA Baggage Tag validation (10 digits with check digit)
  function validaIATATag(code){
    if(!/^\d{10}$/.test(code)) return false;
    const digits = code.split('').map(d=>+d);
    const check = digits.pop();
    let sum = 0;
    for(let i=0;i<digits.length;i++){
      let v = digits[i];
      v = (i%2===0) ? v*3 : v*1;
      sum += v;
    }
    const calc = (10 - (sum % 10)) % 10;
    return calc === check;
  }

  // ------------------ UI / State functions ------------------
  function setActiveVuelo(vueloId){
    state.active = vueloId; db.save(state); renderActive(); renderVueloTable(); renderVuelos(); renderHistorial();
  }
  function getActiveVuelo(){ return state.vuelos.find(v=>v.id===state.active) || null; }
  function ensureSesionFromForm(){
    const n = $('#vueloNumero').value.trim().toUpperCase();
    const f = $('#vueloFecha').value || new Date().toISOString().slice(0,10);
    const o = $('#origen').value.trim().toUpperCase();
    const d = $('#destino').value.trim().toUpperCase();
    if(!n) { alert('Ingrese n√∫mero de vuelo'); return null; }
    let v = state.vuelos.find(x=>x.numero===n && x.fecha===f);
    if(!v){ v = { id:newId(), numero:n, fecha:f, origen:o||'', destino:d||'' }; state.vuelos.push(v); }
    else { v.origen=o||v.origen; v.destino=d||v.destino; }
    db.save(state); setActiveVuelo(v.id); return v;
  }

  function addScanRaw(code){
    const v = getActiveVuelo();
    if(!v){ alert('No hay sesi√≥n de vuelo activa. Inicie/actualice primero.'); play(false); return; }
    const operador = $('#operador').value.trim() || '';
    const valida = $('#chkValidar').checked ? validaIATATag(code) : true;
    const duplicados = $('#chkDuplicados').checked;
    const mismoVuelo = s => s.vueloId===v.id && s.code===code;
    if(!valida){ toast(`Etiqueta no v√°lida: ${code}`, 'err'); play(false); markLast(code,'err'); return; }
    if(duplicados && state.scans.some(mismoVuelo)){
      toast(`Duplicado en este vuelo: ${code}`, 'warn'); play(false); markLast(code,'dup'); return; }
    const scan = { id:newId(), vueloId:v.id, vuelo:v.numero, fecha:v.fecha, ruta:`${v.origen||''}-${v.destino||''}`.replace(/^-|-$|--/g,''), ts:new Date().toISOString(), code, operador };
    state.scans.unshift(scan);
    db.save(state);
    renderVueloTable(); renderVuelos(); renderHistorial();
    $('#ultimaLectura').textContent = code;
    $('#totalVuelo').textContent = state.scans.filter(s=>s.vueloId===v.id).length;
    play(true);
  }

  function markLast(code, cls){
    const tbody = $('#tablaVuelo tbody');
    const row = tbody.querySelector('tr');
    if(row){ row.classList.add(cls==='dup'?'dup':'err'); }
    $('#ultimaLectura').textContent = code;
  }

  function toast(msg, type='info'){ console.log(`[${type}]`, msg); }

  // ------------------ Render ------------------
  function renderActive(){ const v = getActiveVuelo(); $('#vueloActivo').textContent = v ? `${v.numero} ‚Ä¢ ${v.fecha}${v.origen||v.destino?` ‚Ä¢ ${v.origen||''}-${v.destino||''}`:''}` : '‚Äî'; }
  function renderVueloTable(){
    const v = getActiveVuelo();
    const tbody = $('#tablaVuelo tbody'); tbody.innerHTML = '';
    if(!v) return;
    const items = state.scans.filter(s=>s.vueloId===v.id).sort((a,b)=>b.ts.localeCompare(a.ts));
    items.forEach((s,idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><input type="checkbox" data-id="${s.id}"></td><td>${items.length - idx}</td><td>${s.code}</td><td>${fmtDateTime(s.ts)}</td><td>${s.operador||''}</td>`;
      tbody.appendChild(tr);
    });
    $('#totalVuelo').textContent = items.length;
  }
  function renderVuelos(){
    const tbody = $('#tablaVuelos tbody'); tbody.innerHTML = '';
    const stats = state.vuelos.map(v=>({ v, count: state.scans.filter(s=>s.vueloId===v.id).length }))
      .sort((a,b)=> (b.v.fecha+a.v.numero).localeCompare(b.v.fecha+a.v.numero));
    stats.forEach(({v,count})=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${v.numero}</td><td>${v.fecha}</td><td>${(v.origen||'')}-${(v.destino||'')}</td><td>${count}</td><td>
        <button class="btn" data-action="activar" data-id="${v.id}">Activar</button>
        <button class="btn" data-action="csv" data-id="${v.id}">CSV</button>
        <button class="btn danger" data-action="del" data-id="${v.id}">Eliminar</button>
      </td>`;
      tbody.appendChild(tr);
    });
  }
  function renderHistorial(){
    const tbody = $('#tablaHistorial tbody'); tbody.innerHTML = '';
    state.scans.slice(0,1000).forEach(s=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${s.vuelo}</td><td>${fmtDateTime(s.ts)}</td><td>${s.code}</td><td>${s.operador||''}</td>`;
      tbody.appendChild(tr);
    });
  }

  // ------------------ UI Events ------------------
  // Menu desplegable
  $('#hamb').addEventListener('click',()=>{
    const nav = $('#tabs'); nav.classList.toggle('collapsed'); nav.classList.toggle('expanded');
  });

  $$('#tabs .tab').forEach(btn=>btn.addEventListener('click',()=>{
    $$('#tabs .tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    ['escaneo','vuelos','historial','exportar','ayuda'].forEach(id=>$('#'+id).style.display='none');
    const tab = btn.dataset.tab;
    $('#'+tab).style.display = tab==='escaneo' ? 'grid' : 'block';
    if(tab==='escaneo'){ $('#scanInput').focus(); }
  }));

  // Sesi√≥n
  $('#btnNuevaSesion').addEventListener('click', ensureSesionFromForm);
  $('#btnCargarSesion').addEventListener('click', ()=>{
    const n = prompt('Ingrese n√∫mero de vuelo (exacto)');
    if(!n) return;
    const candidatos = state.vuelos.filter(v=>v.numero.toUpperCase()===n.toUpperCase());
    if(candidatos.length===0){ alert('No se encontraron sesiones para ese vuelo.'); return; }
    if(candidatos.length===1){ setActiveVuelo(candidatos[0].id); return; }
    const idx = prompt('Hay varias fechas. Elija √≠ndice:\n' + candidatos.map((v,i)=>`${i+1}) ${v.fecha} ${v.origen||''}-${v.destino||''}`).join('\n'));
    const i = (+idx||0)-1; if(candidatos[i]) setActiveVuelo(candidatos[i].id);
  });

  // Modo entrada
  $('#modoEntrada').addEventListener('change',()=>{
    const m = $('#modoEntrada').value;
    $('#zonaTeclado').style.display = m==='teclado' ? 'block' : 'none';
    $('#zonaCamara').style.display = m==='camara' ? 'block' : 'none';
    $('#zonaManual').style.display = m==='manual' ? 'block' : 'none';
    if(m==='teclado') $('#scanInput').focus();
  });

  // Teclado (Zebra)
  $('#scanInput').addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){ e.preventDefault(); const val = $('#scanInput').value.trim(); if(val){ addScanRaw(val); $('#scanInput').value=''; } }
  });

  // Manual
  $('#btnAgregarManual').addEventListener('click', ()=>{ const val = $('#manualInput').value.trim(); if(val){ addScanRaw(val); $('#manualInput').value=''; } });

  // Deshacer / borrar
  $('#btnDeshacer').addEventListener('click', ()=>{
    const v = getActiveVuelo(); if(!v) return;
    const idx = state.scans.findIndex(s=>s.vueloId===v.id);
    if(idx>-1){ state.scans.splice(idx,1); db.save(state); renderVueloTable(); renderVuelos(); renderHistorial(); }
  });
  $('#chkAll').addEventListener('change',()=>{ $$('#tablaVuelo tbody input[type="checkbox"]').forEach(c=>c.checked=$('#chkAll').checked); });
  $('#btnBorrarSeleccionadas').addEventListener('click',()=>{
    const ids = $$('#tablaVuelo tbody input[type="checkbox"]:checked').map(c=>c.dataset.id);
    if(!ids.length) return;
    if(!confirm('Borrar seleccionadas?')) return;
    state.scans = state.scans.filter(s=>!ids.includes(s.id));
    db.save(state); renderVueloTable(); renderVuelos(); renderHistorial();
  });

  // Tabla vuelos acciones
  $('#tablaVuelos').addEventListener('click',(e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const id = btn.dataset.id; const action = btn.dataset.action;
    if(action==='activar') setActiveVuelo(id);
    if(action==='csv') exportCSV(state.scans.filter(s=>s.vueloId===id));
    if(action==='del'){
      if(!confirm('Eliminar vuelo y sus lecturas?')) return;
      state.scans = state.scans.filter(s=>s.vueloId!==id);
      state.vuelos = state.vuelos.filter(v=>v.id!==id);
      if(state.active===id) state.active=null;
      db.save(state); renderActive(); renderVueloTable(); renderVuelos(); renderHistorial();
    }
  });

  // Exportar
  function exportCSV(rows){
    const header = ['vuelo','fecha','ruta','timestamp','etiqueta','operador'];
    const lines = rows.map(r=>[r.vuelo,r.fecha,r.ruta||'',r.ts,r.code,r.operador||''].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','));
    const csv = [header.join(','), ...lines].join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'),{href:url,download:`escaneos_${new Date().toISOString().replace(/[:T]/g,'-').slice(0,16)}.csv`});
    a.click(); URL.revokeObjectURL(url);
  }
  $('#btnExportVuelo').addEventListener('click',()=>{ const v = getActiveVuelo(); if(!v) return alert('No hay vuelo activo.'); exportCSV(state.scans.filter(s=>s.vueloId===v.id)); });
  $('#btnExportTodo').addEventListener('click',()=> exportCSV(state.scans));

  // Backup / restore / purgar
  $('#btnBackup').addEventListener('click',()=>{
    const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'),{href:url,download:`backup_scanner_${Date.now()}.json`}); a.click(); URL.revokeObjectURL(url);
  });
  $('#fileRestore').addEventListener('change',async (e)=>{
    const file = e.target.files?.[0]; if(!file) return;
    try{
      const text = await file.text(); const data = JSON.parse(text);
      if(!data || !Array.isArray(data.vuelos) || !Array.isArray(data.scans)) throw new Error('Formato inv√°lido');
      state = data; db.save(state); renderActive(); renderVueloTable(); renderVuelos(); renderHistorial();
      alert('Restaurado OK');
    }catch(err){ alert('Error restaurando: '+err.message); }
  });
  $('#btnPurgar').addEventListener('click',()=>{
    if(!confirm('¬øSeguro que desea borrar TODOS los datos locales?')) return;
    state = { vuelos:[], scans:[], active:null }; db.save(state); renderActive(); renderVueloTable(); renderVuelos(); renderHistorial();
  });

  // ------------------ C√°mara + Scanning ------------------
  let stream = null;
  let currentDeviceId = null;
  let camLoop = false;
  let detector = null; // BarcodeDetector
  let zxingReader = null; // ZXing fallback
  let torchOn = false;
  const video = $('#video');
  const listaCamaras = $('#listaCamaras');
  const camStatus = $('#camStatus');

  async function initCamaras(){
    try{
      const devices = (await navigator.mediaDevices.enumerateDevices()).filter(d=>d.kind==='videoinput');
      listaCamaras.innerHTML = '';
      devices.forEach((d,i)=>{
        const o=document.createElement('option'); o.value=d.deviceId; o.textContent=d.label||`C√°mara ${i+1}`; listaCamaras.appendChild(o);
      });
      if(devices.length) listaCamaras.value = devices[0].deviceId;
    }catch(err){ console.warn('initCamaras:', err); }
  }

  async function startCam(){
    try{
      stopCam();
      const deviceId = listaCamaras.value || undefined;
      const constraints = { video: { deviceId: deviceId ? { exact: deviceId } : undefined, facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } , audio:false };
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      currentDeviceId = deviceId;
      video.srcObject = stream;
      await video.play().catch(()=>{});
      camStatus.textContent = `C√°mara iniciada (${deviceId? 'deviceId':'default'})`;
      await setupDetector();
      camLoop = true; loopDetect();
    }catch(err){ alert('No se pudo iniciar la c√°mara: '+(err.message||err)); camStatus.textContent = 'Error c√°mara'; }
  }

  function stopCam(){
    camLoop = false;
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    video.srcObject = null;
    camStatus.textContent = 'C√°mara detenida';
    detector = null;
  }

  async function setupDetector(){
    // Prefer native BarcodeDetector
    if('BarcodeDetector' in window){
      const formats = ['code_128','ean_13','ean_8','upc_a','upc_e','code_39','qr_code','code_93','itf','codabar'];
      try{
        detector = new BarcodeDetector({formats});
        camStatus.textContent = 'Usando BarcodeDetector nativo';
        return;
      }catch(e){ console.warn('BarcodeDetector init failed',e); detector = null; }
    }
    // ZXing fallback
    if(window.ZXing && window.ZXing.BrowserMultiFormatReader){
      zxingReader = new ZXing.BrowserMultiFormatReader();
      camStatus.textContent = 'Usando ZXing (fallback)';
      return;
    }
    camStatus.textContent = 'No se encontr√≥ detector (BarcodeDetector ni ZXing)';
  }

  async function loopDetect(){
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    while(camLoop && video && !video.paused){
      try{
        const vw = video.videoWidth, vh = video.videoHeight;
        if(vw && vh){
          canvas.width = vw; canvas.height = vh;
          ctx.drawImage(video,0,0,vw,vh);
          if(detector){
            // native detector works directly on video or ImageBitmap, but detect accepts canvas as well
            try{
              const results = await detector.detect(video);
              if(results && results.length){
                const val = results[0].rawValue?.trim();
                if(val){ addScanRaw(val); await sleep(600); }
              }
            }catch(e){ /* ignore occasional */ }
          } else if(zxingReader){
            try{
              const luminanceSource = zxingReader.createLuminanceSource(canvas);
              // Using decodeFromCanvas is convenient in latest builds, but we'll use decodeFromImageElement fallback:
              const result = await zxingReader.decodeFromCanvas(canvas);
              if(result && result.text){ addScanRaw(result.text.trim()); await sleep(600); }
            }catch(e){ /* no code */ }
          }
        }
      }catch(e){ console.warn('loopDetect err', e); }
      await sleep(150);
    }
  }

  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

  async function toggleTorch(on){
    if(!stream){ alert('Inicie la c√°mara primero'); return; }
    const track = stream.getVideoTracks()[0];
    if(!track) return;
    const capabilities = track.getCapabilities ? track.getCapabilities() : {};
    // Prefer ImageCapture torch
    try{
      if('torch' in capabilities){
        await track.applyConstraints({ advanced: [{ torch: !!on }] });
        torchOn = !!on; $('#btnLinterna').textContent = torchOn ? 'Linterna OFF' : 'Linterna ON';
        return;
      }
      // Fallback: ImageCapture
      if(window.ImageCapture){
        const ic = new ImageCapture(track);
        const photoCapabilities = await ic.getPhotoCapabilities().catch(()=>null);
        if(photoCapabilities && photoCapabilities.fillLightMode && photoCapabilities.fillLightMode.length){
          // no direct torch control in many browsers via ImageCapture; attempt applyConstraints
          await track.applyConstraints({ advanced: [{ torch: !!on }] });
          torchOn = !!on; $('#btnLinterna').textContent = torchOn ? 'Linterna OFF' : 'Linterna ON';
          return;
        }
      }
      alert('Linterna no soportada en este dispositivo / navegador.');
    }catch(err){
      console.warn('toggleTorch err', err);
      alert('No se pudo cambiar la linterna: ' + (err.message || err));
    }
  }

  // Cam buttons
  $('#btnCamara').addEventListener('click',()=> startCam());
  $('#btnPausarCam').addEventListener('click',()=> stopCam());
  $('#listaCamaras').addEventListener('change', async ()=> {
    if($('#modoEntrada').value!=='camara') return;
    await startCam();
  });
  $('#btnLinterna').addEventListener('click', async ()=>{
    await toggleTorch(!torchOn);
  });

  // Init camera list on load
  (async ()=>{ await initCamaras(); })();

  // ------------------ Auto-scan from external triggers (simulate Zebra keyboard) ---------------
  // If you want to auto-add codes from other means, keep addScanRaw available.

  // ------------------ Init UI ------------------
  (function init(){
    if(!$('#vueloFecha').value) $('#vueloFecha').value = new Date().toISOString().slice(0,10);
    renderActive(); renderVueloTable(); renderVuelos(); renderHistorial();
    $('#scanInput').focus();
    // Keep camera controls hidden unless supported
    initCamaras();
  })();
  </script>
</body>
</html>
