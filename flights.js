(async()=>{const container=document.getElementById('flightsList');const all=await StorageAPI.getAllBatches();const bySession={};for(const b of all){const sid=b?.meta?.sessionId||`legacy-${b.id}`;if(!bySession[sid])bySession[sid]={meta:b.meta||{},batches:[],total:0};bySession[sid].batches.push(b);bySession[sid].total+=(b.items||[]).length}function render(list){container.innerHTML='';list.forEach(f=>{const div=document.createElement('div');div.className='item';const m=f.meta||{};const title=`${m.vuelo||'(vuelo)'} • ${m.origen||''}→${m.destino||''}`;const sup=m.supervisor||m.responsable||'';div.innerHTML=`<div class="item-head"><strong>${title}</strong><small>${f.total} bultos • ${f.batches.length} carros</small></div><div class="item-body"><div>${sup}</div><details><summary>Ver carros</summary><div class="list">${f.batches.map(b=>{const codes=(b.items||[]).map(i=>i.code).join('\n');const count=(b.items||[]).length;const when=new Date(b.created).toLocaleString();return `<div class="item"><div class="item-head"><strong>Carro ${b.meta?.carro||'—'} (Cart #${b.meta?.cartIndex||'?'})</strong><small>${count} • ${when}</small></div><pre class="codes">${codes}</pre></div>`}).join('')}</div></details></div>`;container.appendChild(div)})}function apply(){const fv=document.getElementById('q_vuelo').value.trim().toLowerCase();const fo=document.getElementById('q_origen').value.trim().toLowerCase();const fd=document.getElementById('q_destino').value.trim().toLowerCase();const fr=document.getElementById('q_resp').value.trim().toLowerCase();const arr=Object.values(bySession).filter(f=>{const m=f.meta||{};return(!fv||(m.vuelo||'').toLowerCase().includes(fv))&&(!fo||(m.origen||'').toLowerCase().includes(fo))&&(!fd||(m.destino||'').toLowerCase().includes(fd))&&(!fr||((m.supervisor||m.responsable||'').toLowerCase().includes(fr)))}) ;render(arr)}document.getElementById('q_apply').onclick=apply;document.getElementById('q_clear').onclick=()=>{['q_vuelo','q_origen','q_destino','q_resp'].forEach(id=>document.getElementById(id).value='');render(Object.values(bySession))};render(Object.values(bySession))})();